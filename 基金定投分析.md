<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

最近看了一本书《定投十年财务自由》，作者叫银行螺丝钉，该书的观点就是：长期定投指数基金，可以跑赢大盘，是普通投资者的很好的选择。

为了验证这个观点，为下来的定投做一些自己的分析和验证，我爬取了比较随意选择的60只公募基金的2020年7月份以前的净值数据，模拟每个月定投1000元，看看年收益如何。

数据是从天天基金的一个web接口拉取的。

因为2020年上半年基金普遍大涨，这是一种不可奢求的运气，为了泛化起见，模拟定投只计算从基金发起到2019年底。

代码如下：

```python
# -*- coding: utf-8 -*-

# get fund net value dataset from http://fund.eastmoney.com
# check if it is profitable to invest some fund each month

import requests
import datetime
import time
import execjs
from lxml import etree
import os.path
import pickle
import math

class Fund:
    def __init__(self, fundCode:str):
        self.fundCode = fundCode
        self.fundvalue = {} #type:dict
        filename = "./data/%s.fund"%(fundCode)
        if os.path.exists(filename):
            with open(filename, 'rb') as f:
                self.fundvalue = pickle.load(f)
        else:
            self.__download()
            with open(filename, 'wb') as f:
                pickle.dump(self.fundvalue, f)

    def __download(self):
        # http://fund.eastmoney.com/f10/F10DataApi.aspx?type=lsjz&code=161616&page=40&sdate=2002-01-01&edate=2020-07-17&per=49
        now = datetime.datetime.now()
        today = now.strftime("%Y-%m-%d")
        #print(today)
        self.fundvalue = {}
        for page in range(1,1000):
            url = "http://fund.eastmoney.com/f10/F10DataApi.aspx?type=lsjz&code=%s&page=%d&sdate=2000-01-01&edate=%s&per=20"%(self.fundCode, page, today)
            response = requests.get(url)
            response = response.text #type:str
            #print(response)
            if response.__contains__("暂无数据"):
                break
            object = execjs.eval(response.replace("var ", "").replace(";","").replace("table ", "table id='FundNetValue' "))
            curpage = object["curpage"]
            records = object["records"]
            pages = object["pages"]
            doc = etree.HTML("<html><body>"+object["content"]+"</body></html>")
            recnum = 20
            if curpage == pages: #last page
                recnum = records % 20

            for row in range(1, recnum+1):
                #print(doc.xpath("//table[@id=\"FundNetValue\"]/tbody/tr[%d]//td/text()"%(row)))
                dt = doc.xpath("//table[@id=\"FundNetValue\"]/tbody/tr[%d]//td[1]/text()"%(row))
                netval = doc.xpath("//table[@id=\"FundNetValue\"]/tbody/tr[%d]//td[2]/text()"%(row))
                sumval = doc.xpath("//table[@id=\"FundNetValue\"]/tbody/tr[%d]//td[3]/text()" % (row))

                if len(netval) == 1:
                    netval = netval[0]
                else:
                    print("no netval!", response)
                    continue
                #some fund has no sum value
                if len(sumval) == 1:
                    sumval = sumval[0]
                else:
                    sumval = netval

                self.fundvalue[dt[0]] = {"netval":netval, "sumval":sumval}

            if pages <= page:
                break
            time.sleep(1) # avoid to frequently request the website

        #print(self.fundvalue)

    def automatic_invest(self):
        dt = [*self.fundvalue.keys()]
        dt.sort()
        year_mon = ""
        share = 0.0
        cost = 0.0
        lastday = ""
        for day in dt:
            if day[0:4] == "2020": # 2020 first half year, there is a boom in stock/fund market, get rid of this influence.
                break
            lastday = day
            if day[0:7] != year_mon:
                #print(day, self.fundvalue[day])
                year_mon = day[0:7]
                share += 1000.0 / float(self.fundvalue[day]["netval"])
                cost += 1000.0
        if cost < 1000:
            return 0, 0, 0

        years = cost/12000
        times = float(self.fundvalue[lastday]["netval"])*share / cost
        rate = math.pow(10, math.log10(times) / years)

        return times, years , rate

def __main__():
    code = ["164402", "160643", "502003", "502010", "501048", "257060", "005542",
            "001891", "161616", "004075", "519736", "002803" , "110003", "007784",
            "160620", "005911", "710302", "501010", "270023", "004973", "003745",
            "006751",  "001717","004851", "001915", "320007", "002939", "519674",
            "005911", "002560", "000297", "005461", "001045", "710301", "710302",
            "161726", "007300", "007301", "501009", "501010", "001984", "002891",
            "001691", "006308", "270023", "004860", "004749", "004973", "003468",
            "002302", "004503", "002719", "007378", "007377", "002552", "161838",
            "009411", "009857", "009858", "009770", "161223", "519677", "000478"]
    total = 0.0
    cnt = 0
    for c in code:
        f = Fund(c)
        (t, y, r) = f.automatic_invest()
        print("%s, %.02f, %.02f, %.03f"%(c,t,y,r) )
        total += r*y
        cnt += y
    print("invest by random:", total/ cnt)


__main__()
```

输入如下：

```c
164402, 1.09, 4.83, 1.018
160643, 0.98, 2.58, 0.991
502003, 1.25, 4.50, 1.051
502010, 1.11, 4.50, 1.024
501048, 1.21, 2.08, 1.096
257060, 1.02, 7.58, 1.002
005542, 1.39, 1.75, 1.205
001891, 1.12, 4.33, 1.026
161616, 1.22, 7.50, 1.027
004075, 1.47, 2.67, 1.154
519736, 1.62, 5.67, 1.089
002803, 1.46, 3.50, 1.114
110003, 1.95, 7.58, 1.092
007784, 1.03, 0.17, 1.223
160620, 1.08, 7.33, 1.010
005911, 1.66, 1.17, 1.545
710302, 1.08, 7.50, 1.011
501010, 1.23, 3.08, 1.070
270023, 1.32, 9.42, 1.030
004973, 0.75, 2.33, 0.885
003745, 1.58, 2.75, 1.181
006751, 1.31, 0.83, 1.378
001717, 1.49, 3.92, 1.107
004851, 1.44, 2.42, 1.163
001915, 1.30, 4.08, 1.066
320007, 1.31, 10.83, 1.025
002939, 1.63, 3.42, 1.153
519674, 2.65, 9.08, 1.113
005911, 1.66, 1.17, 1.545
002560, 1.16, 3.75, 1.040
000297, 1.16, 4.92, 1.031
005461, 1.22, 1.67, 1.124
001045, 1.15, 3.33, 1.043
710301, 1.10, 7.50, 1.013
710302, 1.08, 7.50, 1.011
161726, 1.23, 4.67, 1.045
007300, 1.28, 0.58, 1.519
007301, 1.27, 0.58, 1.514
501009, 1.23, 3.08, 1.069
501010, 1.23, 3.08, 1.070
001984, 1.33, 3.75, 1.079
002891, 1.26, 3.08, 1.078
001691, 1.18, 4.33, 1.039
006308, 1.28, 1.33, 1.201
270023, 1.32, 9.42, 1.030
004860, 0.94, 2.42, 0.974
004749, 0.91, 2.42, 0.961
004973, 0.75, 2.33, 0.885
003468, 0.56, 3.08, 0.828
002302, 0.76, 3.42, 0.924
004503, 1.05, 2.67, 1.020
002719, 1.03, 3.67, 1.009
007378, 1.02, 0.58, 1.035
007377, 1.02, 0.58, 1.037
002552, 1.09, 3.83, 1.022
161838, 0.00, 0.00, 0.000
009411, 0.00, 0.00, 0.000
009857, 0.00, 0.00, 0.000
009858, 0.00, 0.00, 0.000
009770, 0.00, 0.00, 0.000
161223, 1.52, 4.83, 1.091
519677, 1.08, 5.83, 1.014
000478, 1.16, 6.00, 1.026
invest by random: 1.0503314828188202
```

有27只年收益超过6%，最后一行更有意思：随意定投这60来只基金，可以获得年收益5%，没有扣减手续费，当然也没有算基金分红，假设两相抵扣吧。