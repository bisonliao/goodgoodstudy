# 在线窄带逻辑层的测试方法 #


压测是我们经常要做的事情，但是我发现这里面有些坑，很容易得出错误结论，而且也确实见到一些似是而非的压测工作。所以写个小文总结一下要注意的点。

## 【1、先明确业务模型】 ##

谈到性能与压测， 一定要先明确业务模型是怎么样的，离开模型直接谈性能数据没有意义。互联网在线业务中很多属于这样一种典型的模型：

1、           业务处理逻辑不是CPU密集型，网络IO非常频繁，通常是小带宽高包量

2、           每个请求比较轻量、要求及时的响应，处理时延在几十到几百毫秒之间，超时的响应没有价值

3、           请求的并发度通常比较高，在几十万到几百万每秒之间，在保证处理不超时的前提下，提升并发处理能力或者说提高系统的吞吐量很有价值

举个有代表性的常见例子，一台服务器，我们希望每秒处理请求10万次，每个请求处理时延200毫秒，那意味着任意时刻，该服务器上都会有2万（10万*0.2秒）个请求正在处理过程中，也就是服务器上任意时刻都有2万个请求上下文并存。

## 【2、压测的注意事项】 ##

1、          客户端要检查回包时延，应答不能超时，压测的稳定状态要保证绝大多数应答都是在规定时延内返回。这一点很容易被忽视，我们可能会关注请求包和应答包的数量一致，但很多时候数量一致但是大量应答超时了，得出了虚高的压测结果

2、          客户端发包和收包数量应该一致；对于udp通信方式，server侧也可以用netstat -su检查丢包情况

3、          客户端尽量均匀的发包，客户端一般的做法是两个线程，一个负责发包，一个负责收包；发包的线程将时间戳写在报文里，通过每发N包就sleep一个最小间隔来控制频率，N可以通过命令行参数传入

4、          server侧通常需要改大接收缓冲区，应对偶尔突发和聚集的请求；通过修改/proc/sys/net/core/rmem_default和/proc/sys/net/core/rmem_max（单位是字节）并重启server程序来实现

5、          server侧要注意是否已经过载，检查接收缓冲区是否越来越满或者一直得不到清空。例如udp服务器可通过netstat -anpl|grep ^udp检查收包缓冲区没有累积越来越多

6、          确保服务器物理内存够用，没有因为页面换入换出影响性能，通过top vmstat等命令查看系统的状态

7、          确保网络会不会有瓶颈。之前我用一个路由器连接两台机器一个做客户端发包一个作为server被压测，发现路由器是瓶颈，换一个交换机连接它们就解决了

8、          需要长时间的压测，不能发几十万个包就了事了，最好有个监控系统可以上报详细信息，利于长时间压测的监控和回顾，光靠眼睛短时间的看看，发现不了中间可能出现的性能波动和不稳定问题

9、          对于有大量磁盘IO的服务程序，磁盘上的数据量、磁盘数据是否足够接近实际情况的碎片化都是需要考虑的。数据库/文件系统的压测通常更复杂，这里不表。