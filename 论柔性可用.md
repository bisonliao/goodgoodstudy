# 论柔性可用 #

## 1什么是柔性可用 ##

简单的说，柔性可用就是退而求其次，不要刚性的依赖某个环节或者特性。

在产品特性方面，当不能提供最完美服务的时候，退而求其次的进行降级，提供可替代的不那么完美的服务。例如展现好友表，拉不到备注，就展现昵称；

或者是当资源有限，而多个产品特性存在资源争用时，停掉优先级不高的特性，保证优先级高的特性。

在技术实现方面，某一个业务流程可能包含多个环节，有的环节是关键的，有的环节是非关键的。对于非关键环节，如果处理失败了，可以采取忽略进而继续后续流程。

背后的哲学，就是假设服务故障的时候，一群用户就站在你的身边，眼巴巴的瞅着你期待你给他们快速解决问题的时候，你如何尽快的给他们一些替代的方案。没有五星级的宾馆，那先来个帐篷吧，亲。

## 2实际运营中的关键点 ##

**2.1预案和精细化运营**

柔性，要求服务的运营是精细化的、尽在掌控的。

以前面的带宽瓶颈的危机为例，这要求我们对各种特性一开始就是分好级别的；且各个特性间的实现要解耦和独立，不能出现停掉某个特性而影响高级别的特性的情况；在错综复杂的网络拓扑、部署架构和调用关系间，要能清楚的知道某个资源有哪些业务在争用，例如某条内网专线上跑了那几个特性的流量？分别是多少G？ 电力资源出现瓶颈时，我们对某个机架停掉，能否第一时间快速的给出哪些模块将受到影响，他们的容灾情况，进而哪些业务特性会受到影响？

**2.2健壮且自动的柔性和实际演练**

设计精巧的机关，往往在需要激发的时候卡壳了。柔性的实施，尽量采用鲁棒的设计。

例如我们登录流程中，如何判断后端某个非关键模块故障了？

一个精巧的设计是：统计过去一段时间的请求失败情况，如果成功率低于95%，就认为后端非关键模块故障了，跳过该环节继续后续流程；那怎么感知后端模块什么时候恢复正常了呢，那还得不断发一些请求包进行试探，发现成功率上来了，就恢复原来的逻辑。复杂吧？

另外一个鲁棒且简单的设计是：请求超时或者系统错误的时候，重试一次，如果重试还失败，那就跳过该环节。

后面这个设计是更优的，它简单、健壮，且可以认为时刻都在被验证，因为每一分钟都会有一定的网络正常超时出现，这个机制不断在被验证。相比之下，精巧的那个设计就差多了。

柔性一定要尽量自动化生效，不可以依靠人工来打开柔性开关的方式。因为故障随时可能出现，一旦出现，运维人员赶到工作场所就需要1个小时，而且在那种压力情况下，手忙脚乱，根本搞不清开关的位置，更何况这个开关可能一年多没有用过了…甚至已经交接过好多轮了…

如果不能做到自动化生效，那么柔性策略需要定期的演练，加以验证。

**2.3合理的超时时间**

模块间调用的超时时间如果设置不合理，会导致柔性策略失效。

简单举个栗子：A调用B是300ms超时，B调用C是500ms超时；B对c有柔性，调用c超时的时候会柔性的继续往下，但是这个没有意义，因为等B成功应答A的时候，A已经超时了，柔性没有起到作用

这个问题很复杂，B的处理过程可能涉及到好几个环节，调用C，调用D、E， B可能在调用C前已经花费了一段时间，几乎无法平衡好上面提到的两个超时时间的关系。

这个问题没有想到特别好的解决办法

**2.4有节制的重试**

前面提到了重试是柔性可用会用到的策略。但重试不能简单的重试，而是有节制的重试：如果成功率高于95%（拍脑袋的数字），才可以重试，否则不能重试，避免引发雪崩加剧后端压力；或者是每个服务器每分钟都限制100次（拍脑袋）重试名额，用完就不重试了。