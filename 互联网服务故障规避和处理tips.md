# 互联网服务故障规避和处理tips #

互联网服务运营过程中，经常出现各种故障。这里故障一词的定义，是指导致局部或者全面的不能为用户/客户提供正常服务的异常事件。故障的规避和处理，有很多经验和方法论在里面。该文尝试整体的概括一下。

## 1 故障前 ##

### 1.1 监控与告警 ###

一定要有一套监控与告警系统，监控：

1. 机器的基本健康度，例如CPU使用率、网卡包量/带宽、磁盘IO等
2. 业务的相关指标，例如A模块访问B模块的请求次数、成功次数、失败次数
3. 能够汇总一个模块下所有机器的上报属性，形成汇总的视图

最好使用标准化的研发和运营框架，不依赖人员的自觉，自动就能对主要指标进行监控和告警，例如标准化框架使用RPC方式进行远程调用，那么就可以自动的在RPC时候进行数据上报到监控系统。

另外，使用标准化的研发和运营框架，除了提高研发效率，很大程度上能够不断积累经验，规避故障。

容易进入的一个误区是：告警设置太多，运维同事收到的告警短信太多，导致信息过载，告警形同虚设。所以需要提炼整个业务的一些核心指标作为监控对象。以在线视频业务为例，可以监控播放量、播放成功率。甚至将这些核心指标的实时动态曲线在墙上的大屏幕上投出来。

### 1.2 容量管理与set化部署 ###

系统的容量应该被量化。

容量应该被监控。

通过set化部署，实现规模化、集装箱化的部署和容量管理，多个set间在故障时候互不影响。

### 1.3 轻重分离与故障隔离 ###

一种情况是，互联网服务，分割开部署多个小世界，其中一个小世界的故障，不会影响到所有服务。当然，因为小世界多了，故障的次数可能会增多，但每次故障影响的范围会比较小。可能故障的期望值是一样的。

还有一种情况是，服务于多个上层业务的平台，对每个上层业务都部署一套平台，当上层业务请求量有暴增等情况的时候，故障是隔离的。或者通过频率限制等手段，达到类似的效果。

### 1.4 柔性可用 ###

柔性可用分两方面：

1. 产品层面的，例如在线视频服务的个性化首页，当用户画像等非关键模块故障的时候，提供一个千人一面的静态首页，至少保证服务基本可用
2. 模块调用层面的，下游非关键模块故障的时候，不请求该模块，直接继续后续业务逻辑的处理。

详细的情况，可以见我的另外一个小文：

[论柔性可用](https://github.com/bisonliao/goodgoodstudy/blob/master/%E8%AE%BA%E6%9F%94%E6%80%A7%E5%8F%AF%E7%94%A8.md)

### 1.5 发布规范 ###

各个团队根据自己的情况指定相应的规范，例如：

1. 必须灰度发布
2. 一轮发布的多次灰度，每次灰度执行后，都必须在工位上观察系统情况
3. 必须在工作时间发布，其他时间需要上级审批
4. 每次发布，都必须填写相应的发布单，确保有记录可查；需要填写重点查看的指标曲线

### 1.6 过载保护 ###

最好使用标准化的开发框架，在开发框架的网络IO等部分实现过载保护：对于超时的积压的请求，直接拒绝。

一请求失败就重试是灾难。有克制的重试才能避免雪崩，例如每1s中内最多重试10次的配额。

## 2 故障中 ##

### 2.1 安民告示 ###

详细见我的另外一个小文：

[论安民告示](https://github.com/bisonliao/goodgoodstudy/blob/master/%E8%AE%BA%E5%AE%89%E6%B0%91%E5%91%8A%E7%A4%BA.md)

### 2.2 故障处理流程和经理 ###

故障处理应该有明确流程，各个团队应该制定适合自己的流程，有一些经验供参考：

1. 明确故障经理，负责整体的统筹，避免群体的责任稀释
2. 第一时间明确：故障对用户/客户的影响（而不是技术上的故障表现），量化影响程度和范围，发生时间等信息，并给相关领导和同事做好信息强同步
3. 以恢复服务为第一要务，而不是追责、定位bug
4. 处理过程中，定时给相关领导团队同步处理进度

### 2.3 快速扩容能力 ###

很多故障是因为容量过载导致的，快速扩容能力非常重要。例如使用docker镜像的方式。

## 3 故障后 ##

### 3.1 故障总结与改进 ###

故障后，要总结故障的原因、发现是否及时、处理过程是否高效等，并给出S.M.A.R.T的改进措施并跟进落实

### 3.2 可用性的量化评估 ###

故障后，要量化评估对服务可用性的影响，并对责任进行评定和处罚。

